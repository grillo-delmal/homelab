---

- name: Prepare services
  ansible.builtin.dnf:
    name:
      - python
      - python3-pip
      - git
      - libglvnd-glx

- name: Install ComfyUI
  ansible.builtin.git:
    repo: https://github.com/comfyanonymous/ComfyUI.git
    dest: /opt/ComfyUI
    version: v0.3.56

- name: Fix pip
  ansible.builtin.pip:
    name:
      - packaging

- name: Install venv
  ansible.builtin.shell:
    cmd: |
      python -m venv /opt/ComfyUI/venv
    creates:
      /opt/ComfyUI/venv

- name: Install torch stuff
  ansible.builtin.pip:
    name:
      - torch
      - torchvision
      - torchaudio
    extra_args: "--index-url https://download.pytorch.org/whl/rocm6.4"
    virtualenv: /opt/ComfyUI/venv

- name: Install requirements
  ansible.builtin.pip:
    requirements: /opt/ComfyUI/requirements.txt
    virtualenv: /opt/ComfyUI/venv

- name: Install Unload Model Node
  ansible.builtin.git:
    repo: https://github.com/SeanScripts/ComfyUI-Unload-Model
    dest: /opt/comfyui_base_dir/custom_nodes/ComfyUI-Unload-Model
    version: main

- name: Install models
  ansible.builtin.shell:
    cmd: |
      mkdir -p /opt/comfyui_base_dir/models/{{ item.type }}/
      curl -L '{{ item.url }}' \
        -o '/opt/comfyui_base_dir/models/{{ item.type }}/{{ item.name }}'
    creates: /opt/comfyui_base_dir/models/{{ item.type }}/{{ item.name }}
  loop: '{{ comfyui_config.models }}'

- name: Add ComfyUI.service
  ansible.builtin.copy:
    src: ComfyUI.service
    dest: /usr/lib/systemd/system/ComfyUI.service
    force: true
    mode: '0644'
  register: add_service_result

- name: Just force systemd to reread configs
  ansible.builtin.systemd_service:
    daemon_reload: true
  when: add_service_result is changed # noqa: no-handler
  notify:
    - 'comfyui : Restart ComfyUI'

- name: Start ComfyUI
  ansible.builtin.service:
    name: ComfyUI.service
    enabled: true
    state: started
