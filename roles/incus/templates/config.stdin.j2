architecture: x86_64
config:
{% if container.incus_config.cores is defined %}
  limits.cpu: '{{ container.incus_config.cores }}'
{% endif %}
{% if container.incus_config.memory is defined %}
  limits.memory: '{{ container.incus_config.memory }}'
{% else %}
  limits.memory: 4GiB
{% endif %}
  limits.memory.swap: false
{% if container.incus_config.privileged is defined %}
  security.privileged: '{{ container.incus_config.privileged }}'
{% endif %}
{% if container.incus_config.nesting is defined %}
  security.nesting: '{{ container.incus_config.nesting }}'
{% endif %}
devices:
  root:
    type: disk
    path: /
    pool: container-pool
    size: {{ container.incus_config.disk }}
  eno0:
    name: eth0
    nictype: bridged
    parent: br0
    type: nic
  eno1:
    name: eth1
    network: internal
    type: nic
{% if container.storage_mnt is defined %}
{% for storage in container.storage_mnt %}
  disk-device-{{ loop.index0 }}:
    type: disk
    source: {{ btrfs_storage.path }}{{ storage.path }}
    path: {{ storage.target }}
    shift: true
{% if storage.uid is defined %}
    initial.uid: {{ storage.uid }}
{% endif %}
{% if storage.gid is defined %}
    initial.gid: {{ storage.gid }}
{% endif %}
{% if storage.mode is defined %}
    initial.mode: {{ storage.mode }}
{% endif %}
{% endfor %}
{% endif %}
{% if container.incus_config.extra_devices is defined %}
  {{ container.incus_config.extra_devices | to_nice_yaml }}
{% endif %}
