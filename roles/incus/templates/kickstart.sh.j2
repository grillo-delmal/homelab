#!/usr/bin/bash

useradd ansible -d /home/ansible -G users,wheel -m -N
echo 'ansible ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/ansible

chown -R root:root /root/.ssh/
chown -R ansible:ansible /home/ansible/.ssh/
chmod -R 600 /root/.ssh/ /home/ansible/.ssh/

dnf -y install \
    openssh-server \
    firewalld \
    cockpit \
    cockpit-ws \
    cockpit-ws-selinux \
    cockpit-system \
    cockpit-bridge \
    cockpit-podman

cat <<EOF > /etc/ssh/sshd_config.d/30-pubkey-only.conf
PasswordAuthentication no
PubkeyAuthentication yes
EOF

systemctl daemon-reload
systemctl set-default multi-user.target
systemctl disable sshd.socket
systemctl enable firewalld sshd.service cockpit.socket
systemctl start firewalld sshd.service cockpit.socket

firewall-cmd --set-default-zone drop
firewall-cmd --permanent --zone external --remove-service ssh
firewall-cmd --permanent --zone external --add-interface eth0

firewall-cmd --permanent --zone trusted --add-service ssh
firewall-cmd --permanent --zone trusted --add-interface eth1

firewall-cmd --reload
