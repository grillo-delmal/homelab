---

- name: Install minetest server
  ansible.builtin.dnf:
    name: minetest-server

- name: Make sure permissions are fine
  ansible.builtin.file:
    dest: /var/lib/minetest
    owner: minetest
    group: minetest
    recurse: true

- name: Hotfix minetest until patch get's merged
  block:

    - name: Replace minetest@.service with the correct one
      ansible.builtin.copy:
        src: minetest@.service
        dest: /usr/lib/systemd/system/minetest@.service
        force: true
        mode: '0644'
      register: luanti_patch_minetest

    - name: Just force systemd to reread configs
      ansible.builtin.systemd_service:
        daemon_reload: true
      when: luanti_patch_minetest is changed # noqa: no-handler

- name: Set minetest home valiable
  ansible.builtin.set_fact:
    luanti_mine_home: "/var/lib/minetest"

- name: Install mapserver if activated
  when: luanti_config.mapserver is defined
  block:
    - name: Ensure mapserver directory exists
      ansible.builtin.file:
        path: /opt/mapserver
        state: directory
        mode: '0755'

    # yamllint disable rule:line-length
    - name: Install mapserver
      ansible.builtin.unarchive:
        src: "https://github.com/minetest-mapserver/mapserver/releases/download/v4.9.1/mapserver_4.9.1_linux_amd64.tar.gz"
        dest: "/opt/mapserver/"
        owner: minetest
        group: minetest
        remote_src: true
    # yamllint enable rule:line-length

    - name: Install mapserver service
      ansible.builtin.copy:
        src: mapserver@.service
        dest: "/etc/systemd/system/mapserver@.service"
        mode: '0644'
      register: luanti_add_service_result

    - name: Just force systemd to reread configs
      ansible.builtin.systemd_service:
        daemon_reload: true
      when: luanti_add_service_result is changed # noqa: no-handler

    - name: Get mapserver key
      ansible.builtin.command: cat /opt/mapserver_key
      register: luanti_data
      ignore_errors: true
      changed_when: false

    - name: Generate mapserver secretkey
      ansible.builtin.set_fact:
        luanti_mapserver_secretkey: "{{
            lookup('password', '/dev/null length=15 chars=ascii_letters')
          }}"
      when: luanti_data is failed

    - name: Read mapserver secretkey
      ansible.builtin.set_fact:
        luanti_mapserver_secretkey: "{{ luanti_data.stdout }}"
      when: luanti_data is not failed

    - name: Save generated key
      ansible.builtin.copy:
        dest: "/opt/mapserver_key"
        content: "{{ luanti_mapserver_secretkey }}"
        mode: '0600'

- name: Games folder exists
  ansible.builtin.file:
    path: "{{ luanti_mine_home }}/.minetest/games"
    state: directory
    owner: minetest
    group: minetest
    mode: '0755'

- name: Install unzip
  ansible.builtin.dnf:
    name: unzip

- name: Set minetest home valiable
  ansible.builtin.set_fact:
    luanti_mine_sysconfig: "/etc/sysconfig/minetest/{{ luanti_config.world.id }}.conf"
    luanti_mine_config: "/etc/minetest/{{ luanti_config.world.id }}.conf"

- name: Games folder archive exists
  ansible.builtin.file:
    path: "/opt/games/"
    state: directory
    owner: minetest
    group: minetest
    mode: '0755'

- name: Download game
  ansible.builtin.get_url:
    url: '{{ luanti_config.game.url }}'
    dest: "/opt/games/{{
        (luanti_config.game.url | urlsplit('path') | split('/'))[-1]
      }}"
    mode: '0644'
  register: luanti_game_archive

- name: Install new game
  when: luanti_game_archive is changed and not ansible_check_mode
  notify:
    - 'luanti : Restart minetest service'
  block:
    - name: Remove current version of the game if exist
      ansible.builtin.file:
        path: "{{ luanti_mine_home }}/.minetest/games/{{ luanti_config.game.name }}"
        state: absent

    - name: Game is available
      ansible.builtin.unarchive:
        src: "/opt/games/{{
            (luanti_config.game.url | urlsplit('path') | split('/'))[-1]
          }}"
        dest: "{{ luanti_mine_home }}/.minetest/games/"
        owner: minetest
        group: minetest
        remote_src: true

- name: List installed mods
  ansible.builtin.find:
    paths: "{{ luanti_mine_home }}/{{ luanti_config.world.id }}/worldmods/"
    file_type: directory
  register: luanti_installed_mods

- name: Make sure only listed mods exist
  ansible.builtin.file:
    path: "item.path"
    state: absent
  when: "(
    item.path |
      split('/')
    )[-1] not in (
      luanti_config.game.mods |
        default([]) |
          map(attribute='name')
    )"
  loop: "{{ luanti_installed_mods.files }}"

- name: Mods folder archive exists
  ansible.builtin.file:
    path: "/opt/mods/"
    state: directory
    owner: minetest
    group: minetest
    mode: '0755'

- name: Mods are available
  ansible.builtin.include_tasks: mods.yaml
  loop: "{{ luanti_config.game.mods }}"
  when: "'mods' in luanti_config.game"

- name: Configure port
  ansible.builtin.copy:
    content: |
      PORT={{ luanti_config.world.port }}
      GAMEID={{ luanti_config.game.name }}
    dest: "{{ luanti_mine_sysconfig }}"
    mode: '0644'
  notify:
    - 'luanti : Restart minetest service'

- name: Upload the minetest.conf file
  ansible.builtin.template:
    src: minetest.conf.j2
    dest: "{{ luanti_mine_config }}"
    owner: minetest
    group: minetest
    backup: true
    mode: '0644'
  notify:
    - 'luanti : Restart minetest service'

- name: Start service
  ansible.builtin.service:
    name: minetest@{{ luanti_config.world.id }}.service
    enabled: true
    state: started

- name: Run mapserver
  when: luanti_config.mapserver is defined
  block:
    - name: Check if configuration changed
      become: true
      become_user: minetest
      ansible.builtin.template:
        src: mapserver.json.j2
        dest: "{{ luanti_mine_home }}/{{ luanti_config.world.id }}/test.mapserver.json"
        owner: minetest
        group: minetest
        mode: '0644'
      register: luanti_mapserver_canary

    - name: Configure mapserver port
      become: true
      become_user: minetest
      ansible.builtin.template:
        src: mapserver.json.j2
        dest: "{{ luanti_mine_home }}/{{ luanti_config.world.id }}/mapserver.json"
        owner: minetest
        group: minetest
        mode: '0644'
      when: luanti_mapserver_canary is changed # noqa: no-handler
      notify:
        - 'luanti : Restart mapserver service'

    - name: Wait for world to exist
      become: true
      become_user: minetest
      ansible.builtin.wait_for:
        path: "{{ luanti_mine_home }}/{{ luanti_config.world.id }}/map.sqlite"
        state: present

    - name: Start Minetest-mapserver
      ansible.builtin.service:
        name: mapserver@{{ luanti_config.world.id }}.service
        enabled: true
        state: started
