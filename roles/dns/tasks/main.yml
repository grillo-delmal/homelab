---

- name: Prepare services
  ansible.builtin.dnf:
    name:
      - bind
    state: present

- name: Configure bind
  ansible.builtin.template:
    src: named.conf.j2
    dest: /etc/named.conf
    mode: '0644'

- name: Check if raw zone changes
  ansible.builtin.template:
    src: main.zone.j2
    dest: /var/raw.main.zone
    mode: '0644'
  vars:
    serial_num: '0'
  register: raw_zone

- name: Create real zone
  ansible.builtin.template:
    src: main.zone.j2
    dest: /var/named/{{ domain_name }}.zone
    mode: '0644'
  vars:
    serial_num: >-
      {{
        ansible_date_time.year
      }}{{
        "%02d" % ( ansible_date_time.month | int )
      }}{{
        "%02d" % ( ansible_date_time.day | int )
      }}{{
        "%02d" % ( ansible_date_time.hour | int )
      }}
  when: raw_zone is changed
  notify:
    - 'dns : Restart named service'

- name: Get public IP
  community.general.ipify_facts:
    timeout: 15
  tags: ddns

- name: Set domain IP on CloudFlare
  community.general.cloudflare_dns:
    zone: "{{ base_domain_name }}"
    record: "{{ domain_name }}"
    type: A
    value: "{{ ipify_public_ip }}"
    api_token: "{{ cloudflare_token }}"
    proxied: "no"
    solo: "yes"
    state: present

- name: Set *.domain IP on CloudFlare
  community.general.cloudflare_dns:
    zone: "{{ base_domain_name }}"
    record: "*.{{ domain_name }}"
    type: A
    value: "{{ ipify_public_ip }}"
    api_token: "{{ cloudflare_token }}"
    proxied: "no"
    solo: "yes"
    state: present
  notify:
    - 'dns : Restart named service'

- name: BIND is started
  ansible.builtin.systemd:
    name: named.service
    state: started
    enabled: true
